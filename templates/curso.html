{% extends "./base.html" %}

{% block body %}

{% if current_user.rango == "Profe" %}
<div id="personas">
    <h1>id_clase={{ id }}</h1>
</div>
{% endif %}
</div>

<button id="handleButton" onclick="handle()">chat</button>

<div id="personas">

</div>

<div id="chat">
    <form id="post_form" style="text-align: center;" enctype="multipart/form-data">
        <input type="text" id="contenido"><br>
        <input type="file" id="archivo" name="archivo"><br>
        <input type="submit" value="mandar">
    </form>

    <ul id="lista">

    </ul>
</div>


<script>
    const usuarioRango = "{{ current_user.rango }}";
    const id = {{ id| tojson }};

    function handle() {
        var button = document.getElementById("handleButton");
        const text = button.innerText

        var chat= document.getElementById("chat");

        var people= document.getElementById("personas");


    if (button.innerText !== "chat") {
        button.innerText = "chat";
        chat.style.display = "none";
        people.style.display = "block";
    } else {
        button.innerText = "inscriptos";
        chat.style.display = "block";
        people.style.display = "none";
    }
}

    async function loadposts() {
        try {
            const res = await fetch('/api/posts');
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                alert("Error al obtener los posts");
                return;
            }

            data.reverse();
            const container = document.getElementById("lista");
            container.innerHTML = "";

            for (const post of data) {
                if (post.id_curso == id) {
                    const div = document.createElement("div");
                    div.style.marginBottom = "15px";
                    div.style.border = "1px solid black";

                    div.innerHTML = `
                    <h5>${post.autor}  ${post.fecha_publicacion}</h5>
                    <h1>${post.titulo}</h1>
                    <h3>${post.contenido}</h3>
                `;


                    const files = await loadFiles(post.id_post);
                    for (const file of files) {
                        div.appendChild(file);
                    }

                    if (usuarioRango == "Profe") {
                        div.innerHTML += `
                        <button onclick="delete_post(${post.id_post})">delete</button>
                    `;
                    }

                    container.appendChild(div);
                }
            }
        } catch (err) {
            console.error("Error al cargar posts:", err);
            alert("Error al cargar posts.");
        }
    }

    async function loadFiles(id_post) {
        try {
            const res = await fetch(`/api/archivos/${id_post}`);
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                alert("Error al obtener los archivos");
                return [];
            }

            const files = [];
            for (const archivo of data) {
                let element;

                if (archivo.tipo.startsWith("image/")) {
                    element = document.createElement("img");
                    element.src = `data:${archivo.tipo};base64,${archivo.pixel}`;
                    element.style.width = "150px";
                    element.style.height = "150px";
                    element.style.objectFit = "cover";
                    element.style.cursor = "pointer";
                    element.style.margin = "5px";

                    element.addEventListener("click", () => {
                        const modal = document.getElementById("imageModal");
                        const modalImg = document.getElementById("modalImage");
                        modalImg.src = element.src;
                        modal.style.display = "flex";
                    });

                } else if (archivo.tipo.startsWith("video/")) {
                    element = document.createElement("video");
                    element.src = `data:${archivo.tipo};base64,${archivo.pixel}`;
                    element.controls = true;
                    element.style.width = "300px";
                    element.style.margin = "5px";

                } else if (archivo.tipo === "application/pdf") {
                    element = document.createElement("a");
                    element.href = `data:${archivo.tipo};base64,${archivo.pixel}`;
                    element.target = "_blank";
                    element.textContent = "ðŸ“„ Ver PDF";
                    element.style.display = "block";
                    element.style.margin = "5px";

                } else {
                    element = document.createElement("a");
                    element.href = `data:${archivo.tipo};base64,${archivo.pixel}`;
                    element.download = archivo.nombre || "archivo";
                    element.textContent = `â¬‡ Descargar ${archivo.tipo}`;
                    element.style.display = "block";
                    element.style.margin = "5px";
                }

                files.push(element);
            }

            return files;
        } catch (err) {
            console.error("Error al cargar archivos:", err);
            alert("Error al cargar archivos.");
            return [];
        }
    }

    async function loadpeople(){
        try {
            const res = await fetch(`/api/cursos_usuarios/${id}`);
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                alert("Error al obtener las people");
                return;
            }

            const container = document.getElementById("personas");
            container.innerHTML = "";

            for (const email of data) {
                    const div = document.createElement("div");
                    div.style.marginBottom = "15px";
                    div.style.border = "1px solid black";

                    div.innerHTML = `
                    <h1>${email}</h1>
                `;

                    if (usuarioRango == "Profe") {
                        div.innerHTML += `
    <button onclick="delete_people('${email}')">echar</button>
                    `;
                    }

                    container.appendChild(div);
            }
        } catch (err) {
            console.error("Error al cargar people:", err);
            alert("Error al cargar people.");
        }
    }

function delete_people(email) {
    if (!confirm('Â¿Seguro que querÃ©s eliminar este usuario?')) return;

    fetch(`/api/cursos_usuarios/${id}/${email}`, { 
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            loadpeople();  
        } else {
            alert("Error al eliminar: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error al eliminar usuario:", error);
    });
}

    document.getElementById("post_form").addEventListener("submit", async function (event) {
        event.preventDefault();

        const contenido = document.getElementById("contenido").value;
        const email = "{{ current_user.email }}";
        const archivoInput = document.getElementById("archivo");

        if (!contenido && !archivoInput) {
            return alert("Falta contenido");
        }

        const formData = new FormData();
        formData.append("id_curso", id);
        formData.append("titulo", "");
        formData.append("contenido", contenido);
        formData.append("autor", email);

        if (archivoInput.files.length > 0) {
            formData.append("archivo", archivoInput.files[0]);
        }

        try {
            const res = await fetch("/api/posts", {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            if (!data.success) {
                alert("Error: " + data.error);
            } else {
                loadposts();
            }
        } catch (err) {
            console.error("Server error:", err);
            alert("Something went wrong.");
        }
    });

    function delete_post(id_post) {
        if (!confirm('Â¿Seguro que querÃ©s eliminar este post?')) return;

        fetch(`/api/posts/${id_post}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadposts();
                } else {
                    alert("Error al eliminar: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error al eliminar equipo:", error);
            });
    }

    window.onload = function() {
    loadposts();
    loadpeople();
    handle()
};
</script>
{% endblock %}