{% extends "./base.html" %}

{% block body %}
{% if current_user.rango=="Profe" %}
<button>+</button>
</form>
{% else %}

<button>+</button>


{% endif %}

<form id="post_form" style="text-align: center;" enctype="multipart/form-data">
    <input type="text" id="contenido"><br>
    <input type="file" id="archivo" name="archivo"><br>
    <input type="submit" value="mandar">
</form>

<ul id="lista">

</ul>

<script>
    const usuarioRango = "{{ current_user.rango }}";
    const id = {{ id| tojson }};
    async function loadposts() {
        try {
            const res = await fetch('/api/posts');
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                alert("Error al obtener los posts");
                return;
            }
            data.reverse()
            const container = document.getElementById("lista");
            container.innerHTML = "";

            for (const post of data) {
                if (post.id_curso == id) {
                    const div = document.createElement("div");
                    div.style.marginBottom = "15px";
                    div.style.border = "1px solid black";

                    div.innerHTML = `
                <h5>${post.autor}  ${post.fecha_publicacion}</h5>
                <h1>${post.titulo}</h1>
                <h3>${post.contenido}</h3>
            `;

                    container.appendChild(div);
                    if (usuarioRango == "Profe") {
                        div.innerHTML += `
                <button onclick="delete_post(${post.id_post})">delete</button>
            `;

                        container.appendChild(div);

                    }
                }

            }
        } catch (err) {
            console.error("Error al cargar cursos:", err);
            alert("Error al cargar cursos.");
        }
    }

document.getElementById("post_form").addEventListener("submit", async function (event) {
    event.preventDefault();

    const contenido = document.getElementById("contenido").value;
    const email = "{{ current_user.email }}";
    const archivoInput = document.getElementById("archivo");

    if (!contenido) {
        return alert("Falta contenido");
    }

    const formData = new FormData();
    formData.append("id_curso", id);
    formData.append("titulo", "");
    formData.append("contenido", contenido);
    formData.append("autor", email);

    if (archivoInput.files.length > 0) {
        formData.append("archivo", archivoInput.files[0]);
    }

    try {
        const res = await fetch("/api/posts", {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        if (!data.success) {
            alert("Error: " + data.error);
        } else {
            loadposts();
        }
    } catch (err) {
        console.error("Server error:", err);
        alert("Something went wrong.");
    }
});

    function delete_post(id_post) {
        if (!confirm('¿Seguro que querés eliminar este post?')) return;

        fetch(`/api/posts/${id_post}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadposts();
                } else {
                    alert("Error al eliminar: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error al eliminar equipo:", error);
            });
    }
    window.onload = loadposts;
</script>
{% endblock %}