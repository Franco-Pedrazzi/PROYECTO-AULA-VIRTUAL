{% extends "./base.html" %}

{% block body %}

    {% if current_user.is_authenticated == false %}
        <p>Inicia sesión para ver tus cursos</p>
    
    {% else %}

    <ul id="lista"></ul>

    {% if current_user.rango == "Profe" %}
            <button id="boton-formulario" type="button" class="btn btn-primary btn-lg" onclick="mostrarFormulario()">Crear Curso</button>
            <br>

            <div id="form-curso" style="display:none;">
                <input type="text" id="nombre_curso" placeholder="Nombre del curso" style="max-width: 500px; margin-left: -10px;">
                <br>
                <button type="button" class="btn btn-primary btn-lg" onclick="crearCurso()">Crear</button>
                <button type="button" class="btn btn-primary btn-lg" onclick="esconderFormulario()">Cancelar</button>
            </div>
    {%else%}
            <div style="margin-top:20px; padding:10px;">
            <button id="boton-unirse" type="button" class="btn btn-primary btn-lg" onclick="mostrarUnirse()">Unirse a curso</button>

            <div id="form-unirse" style="display:none;">
                <input id="codigo-unirse" type="text" placeholder="Código del curso">
                <button id="boton-unirse" type="button" class="btn btn-primary btn-lg" onclick="unirseCurso()">Unirse</button>
                <button type="button" class="btn btn-primary btn-lg" onclick="esconderUnirse()">Cancelar</button>
            </div>
        </div>
    {% endif %}

</ul>

    {% endif %}


<script>
    async function loadcursos() {
        try {
            const res = await fetch('/api/cursos');
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                return;
            }

            const container = document.getElementById("lista");
            container.innerHTML = "";

            for (const curso of data) {
                const div = document.createElement("div");
                div.style.marginBottom = "15px";
                div.style.border = "1px solid black";
                div.onclick = () => {
                    location.href = `http://` + window.location.host + `/curso/${curso.codigo}`;
                };

                div.innerHTML = `
                <h1><strong>Clase:</strong> ${curso.nombre}</h1>
            `;

            container.appendChild(div);
        }
    } catch (err) {
        if (current_user.is_authenticated == false) {
            console.error("Error al cargar cursos:", err);
        }
        else {
            console.error("Error al cargar cursos:", err);
        }
        
    }
}

function mostrarFormulario() {
    document.getElementById("form-curso").style.display = "inline";
    document.getElementById("boton-formulario").style.display = "none";
}

function esconderFormulario() {
    document.getElementById("form-curso").style.display = "none";
    document.getElementById("boton-formulario").style.display = "inline";
}

function mostrarUnirse() {
    document.getElementById("form-unirse").style.display = "inline";
    document.getElementById("boton-unirse").style.display = "none";
}
function esconderUnirse() {
    document.getElementById("form-unirse").style.display = "none";
    document.getElementById("boton-unirse").style.display = "inline";
}

    async function crearCurso() {
        const nombre = document.getElementById("nombre_curso").value;
        if (!nombre) {
            alert("Falta el nombre del curso");
            return;
        }

        try {
            const res = await fetch("/api/cursos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ nombre })
            });

            const data = await res.json();
            if (data.success) {
                alert("Curso creado correctamente");
                loadcursos();
                document.getElementById("form-curso").style.display = "none";
                document.getElementById("nombre_curso").value = "";
            } else {
                alert("Error: " + data.error);
            }
        } catch (err) {
            console.error("Error creando curso:", err);
            alert("Error al crear el curso");
        }
    }

async function unirseCurso() {
    const codigo = document.getElementById("codigo-unirse").value;
    if (!codigo) {
        alert("Ingresa un código");
        return;
    }

        try {
            const res = await fetch("/api/unirse", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ codigo })
            });

            const data = await res.json();
            if (data.success) {
                alert("Te uniste al curso: " + data.curso.nombre);
                loadcursos();
            } else {
                alert("Error: " + data.error);
            }
        } catch (err) {
            console.error("Error uniendo al curso:", err);
            alert("Error en el servidor");
        }
    }


    function entrar() {

    }

    window.onload = loadcursos();
</script>
{% endblock %}